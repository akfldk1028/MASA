name: "ğŸ” Code Review Assistant"
on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

jobs:
  code-review:
    if: github.event_name == 'pull_request' || (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude review'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Get changed files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git diff --name-only origin/${{ github.base_ref }}..HEAD > changed_files.txt
          else
            # For issue comments, get the PR number and fetch changes
            PR_NUMBER=$(echo "${{ github.event.issue.number }}")
            gh pr diff $PR_NUMBER --name-only > changed_files.txt
          fi
          echo "Changed files:"
          cat changed_files.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Claude Code Review
        id: claude-review
        uses: ./
        with:
          prompt: |
            ğŸ” **ì½”ë“œ ë¦¬ë·° ìˆ˜í–‰**
            
            ë‹¤ìŒ ë³€ê²½ëœ íŒŒì¼ë“¤ì„ ê²€í† í•´ì£¼ì„¸ìš”:
            
            **ê²€í†  í•­ëª©:**
            1. **ì½”ë“œ í’ˆì§ˆ**: ê°€ë…ì„±, ìœ ì§€ë³´ìˆ˜ì„±, ì½”ë”© ìŠ¤íƒ€ì¼
            2. **ì ì¬ì  ë²„ê·¸**: ë¡œì§ ì˜¤ë¥˜, ì˜ˆì™¸ ì²˜ë¦¬ ëˆ„ë½
            3. **ì„±ëŠ¥**: ë¹„íš¨ìœ¨ì ì¸ ì½”ë“œ, ìµœì í™” ê°€ëŠ¥ì„±
            4. **ë³´ì•ˆ**: ë³´ì•ˆ ì·¨ì•½ì , ì…ë ¥ ê²€ì¦
            5. **í…ŒìŠ¤íŠ¸**: í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€, í…ŒìŠ¤íŠ¸ í’ˆì§ˆ
            6. **ì„¤ê³„**: ì•„í‚¤í…ì²˜ íŒ¨í„´, SOLID ì›ì¹™
            
            **ì¶œë ¥ í˜•ì‹:**
            ```
            ## ğŸ“‹ ì½”ë“œ ë¦¬ë·° ê²°ê³¼
            
            ### âœ… ì˜ëœ ì 
            - [ì¢‹ì€ ì ë“¤ ë‚˜ì—´]
            
            ### âš ï¸ ê°œì„  ì‚¬í•­
            #### ğŸ› ë²„ê·¸/ì˜¤ë¥˜
            - [íŒŒì¼ëª…:ë¼ì¸] ì„¤ëª…
            
            #### ğŸš€ ì„±ëŠ¥ ê°œì„ 
            - [íŒŒì¼ëª…:ë¼ì¸] ì„¤ëª…
            
            #### ğŸ”’ ë³´ì•ˆ
            - [íŒŒì¼ëª…:ë¼ì¸] ì„¤ëª…
            
            ### ğŸ’¡ ì œì•ˆì‚¬í•­
            - [êµ¬ì²´ì ì¸ ê°œì„  ë°©ë²•]
            
            ### ğŸ“Š ì „ì²´ í‰ê°€
            - í’ˆì§ˆ: â­â­â­â­â­ (5/5)
            - ë³µì¡ë„: ì¤‘ê°„
            - ìœ„í—˜ë„: ë‚®ìŒ
            ```
            
          allowed_tools: "Read,Grep,Bash(git diff),Bash(git log)"
          
          settings: |
            {
              "enableAllProjectMcpServers": true,
              "customInstructions": "í•œêµ­ì–´ë¡œ ìƒì„¸í•˜ê³  ê±´ì„¤ì ì¸ í”¼ë“œë°± ì œê³µ. ì½”ë“œ ì˜ˆì‹œì™€ í•¨ê»˜ ê°œì„  ë°©ì•ˆ ì œì‹œ."
            }
            
          timeout_minutes: "15"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            // Claude ì‹¤í–‰ ê²°ê³¼ íŒŒì¼ ì½ê¸°
            let claudeOutput = "ë¦¬ë·° ì™„ë£Œ";
            try {
              const logFile = '${{ steps.claude-review.outputs.execution_file }}';
              if (fs.existsSync(logFile)) {
                const logData = JSON.parse(fs.readFileSync(logFile, 'utf8'));
                claudeOutput = logData.result || "ë¦¬ë·° ì™„ë£Œ";
              }
            } catch (error) {
              console.log('ë¡œê·¸ íŒŒì‹± ì˜¤ë¥˜:', error);
            }
            
            const comment = `## ğŸ¤– Claude ì½”ë“œ ë¦¬ë·°
            
${claudeOutput}

---
*ğŸ”„ ë¦¬ë·°ë¥¼ ë‹¤ì‹œ ë°›ìœ¼ë ¤ë©´ \`@claude review\` ì½”ë©˜íŠ¸ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Reply to comment
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            let claudeOutput = "ë¦¬ë·° ì™„ë£Œ";
            try {
              const logFile = '${{ steps.claude-review.outputs.execution_file }}';
              if (fs.existsSync(logFile)) {
                const logData = JSON.parse(fs.readFileSync(logFile, 'utf8'));
                claudeOutput = logData.result || "ë¦¬ë·° ì™„ë£Œ";
              }
            } catch (error) {
              console.log('ë¡œê·¸ íŒŒì‹± ì˜¤ë¥˜:', error);
            }
            
            const reply = `## ğŸ¤– Claude ì½”ë“œ ë¦¬ë·° ê²°ê³¼
            
${claudeOutput}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reply
            });

      - name: Upload review log
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: claude-review-log-${{ github.run_number }}
          path: ${{ steps.claude-review.outputs.execution_file }}
          retention-days: 7