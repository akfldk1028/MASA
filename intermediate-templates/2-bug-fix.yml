name: "ğŸ› Bug Fix Assistant"
on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

jobs:
  bug-fix:
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'bug')) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude fix'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse issue details
        id: parse-issue
        run: |
          # ì´ìŠˆ ë²ˆí˜¸ì™€ ì œëª© ì¶”ì¶œ
          if [ "${{ github.event_name }}" = "issues" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_BODY="${{ github.event.issue.body }}"
          else
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_BODY="${{ github.event.issue.body }}"
          fi
          
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "issue_title=$ISSUE_TITLE" >> $GITHUB_OUTPUT
          
          # ì´ìŠˆ ë‚´ìš©ì„ íŒŒì¼ë¡œ ì €ì¥
          cat > issue_details.txt << 'EOF'
          Title: $ISSUE_TITLE
          Number: #$ISSUE_NUMBER
          Body: $ISSUE_BODY
          EOF

      - name: Run Bug Analysis & Fix
        id: claude-fix
        uses: ./
        with:
          prompt: |
            ğŸ› **ë²„ê·¸ ìˆ˜ì • ìˆ˜í–‰**
            
            **ì´ìŠˆ ì •ë³´:**
            ì´ìŠˆ ë²ˆí˜¸: #${{ steps.parse-issue.outputs.issue_number }}
            ì œëª©: ${{ steps.parse-issue.outputs.issue_title }}
            
            **ìˆ˜í–‰í•  ì‘ì—…:**
            1. **ë²„ê·¸ ë¶„ì„**: ì´ìŠˆ ë‚´ìš©ì„ ì½ê³  ë¬¸ì œë¥¼ íŒŒì•…
            2. **ì½”ë“œë² ì´ìŠ¤ ì¡°ì‚¬**: ê´€ë ¨ íŒŒì¼ë“¤ì„ ì°¾ì•„ì„œ ë¶„ì„
            3. **ê·¼ë³¸ ì›ì¸ ì°¾ê¸°**: ë²„ê·¸ì˜ ì‹¤ì œ ì›ì¸ íŒŒì•…
            4. **ìˆ˜ì • ë°©ì•ˆ ì„¤ê³„**: ì•ˆì „í•˜ê³  íš¨ê³¼ì ì¸ ìˆ˜ì • ë°©ë²• ê³„íš
            5. **ì½”ë“œ ìˆ˜ì •**: ì‹¤ì œ ë²„ê·¸ ìˆ˜ì • êµ¬í˜„
            6. **í…ŒìŠ¤íŠ¸ í™•ì¸**: ìˆ˜ì •ì´ ì œëŒ€ë¡œ ì‘ë™í•˜ëŠ”ì§€ ê²€ì¦
            
            **ì¶œë ¥ í˜•ì‹:**
            ```
            ## ğŸ” ë²„ê·¸ ë¶„ì„ ê²°ê³¼
            
            ### ğŸ“‹ ë¬¸ì œ ìš”ì•½
            - **ì¦ìƒ**: [ë°œìƒí•˜ëŠ” ë¬¸ì œ]
            - **ì˜í–¥ ë²”ìœ„**: [ì–´ë–¤ ê¸°ëŠ¥ì´ ì˜í–¥ë°›ëŠ”ì§€]
            - **ì¬í˜„ ì¡°ê±´**: [ì–¸ì œ ë°œìƒí•˜ëŠ”ì§€]
            
            ### ğŸ” ê·¼ë³¸ ì›ì¸
            - **ìœ„ì¹˜**: [íŒŒì¼ëª…:ë¼ì¸ë²ˆí˜¸]
            - **ì›ì¸**: [êµ¬ì²´ì ì¸ ì›ì¸ ì„¤ëª…]
            - **ì™œ ë°œìƒí–ˆëŠ”ì§€**: [ê·¼ë³¸ì ì¸ ì´ìœ ]
            
            ### ğŸ› ï¸ ìˆ˜ì • ë‚´ì—­
            #### ë³€ê²½ëœ íŒŒì¼:
            - `íŒŒì¼ëª…`: [ìˆ˜ì • ë‚´ìš© ìš”ì•½]
            
            #### ìˆ˜ì • ìƒì„¸:
            [êµ¬ì²´ì ì¸ ìˆ˜ì • ì‚¬í•­ë“¤]
            
            ### âœ… ê²€ì¦ ê²°ê³¼
            - [ìˆ˜ì • í›„ í…ŒìŠ¤íŠ¸ ê²°ê³¼]
            - [ë¶€ì‘ìš©ì´ ì—†ëŠ”ì§€ í™•ì¸]
            
            ### ğŸ“ ì¶”ê°€ ê¶Œì¥ì‚¬í•­
            - [í–¥í›„ ìœ ì‚¬í•œ ë²„ê·¸ ë°©ì§€ ë°©ë²•]
            ```
            
            **ì£¼ì˜ì‚¬í•­:**
            - ê¸°ì¡´ ì½”ë“œì˜ ë™ì‘ì„ ìµœëŒ€í•œ ë³´ì¡´
            - ìµœì†Œí•œì˜ ë³€ê²½ìœ¼ë¡œ ë¬¸ì œ í•´ê²°
            - ë‹¤ë¥¸ ê¸°ëŠ¥ì— ì˜í–¥ ì£¼ì§€ ì•Šë„ë¡ ì£¼ì˜
            - í…ŒìŠ¤íŠ¸ ì½”ë“œë„ í•¨ê»˜ ìˆ˜ì •/ì¶”ê°€í•  ê²ƒ
            
          allowed_tools: "Read,Write,Edit,MultiEdit,Grep,Bash(npm test),Bash(npm run lint)"
          
          settings: |
            {
              "enableAllProjectMcpServers": true,
              "customInstructions": "í•œêµ­ì–´ë¡œ ìƒì„¸í•œ ë¶„ì„ ì œê³µ. ì•ˆì „í•˜ê³  ìµœì†Œí•œì˜ ë³€ê²½ìœ¼ë¡œ ë²„ê·¸ ìˆ˜ì •. í…ŒìŠ¤íŠ¸ í¬í•¨."
            }
            
          timeout_minutes: "20"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Create fix branch
        if: steps.claude-fix.outputs.conclusion == 'success'
        run: |
          # ë¸Œëœì¹˜ ì´ë¦„ ìƒì„±
          BRANCH_NAME="fix/issue-${{ steps.parse-issue.outputs.issue_number }}"
          
          # ë¸Œëœì¹˜ ìƒì„± ë° ì²´í¬ì•„ì›ƒ
          git config user.name "Claude AI"
          git config user.email "claude@anthropic.com"
          git checkout -b "$BRANCH_NAME"
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if git diff --quiet && git diff --cached --quiet; then
            echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          fi
        id: create-branch

      - name: Commit and push changes
        if: steps.create-branch.outputs.has_changes == 'true'
        run: |
          # ëª¨ë“  ë³€ê²½ì‚¬í•­ ì»¤ë°‹
          git add -A
          git commit -m "ğŸ› Fix: ${{ steps.parse-issue.outputs.issue_title }}

          - ì´ìŠˆ #${{ steps.parse-issue.outputs.issue_number }} ìˆ˜ì •
          - Claude AIê°€ ìë™ìœ¼ë¡œ ìƒì„±í•œ ìˆ˜ì •ì‚¬í•­
          
          Co-authored-by: Claude AI <claude@anthropic.com>"
          
          # ì›ê²© ë¸Œëœì¹˜ë¡œ í‘¸ì‹œ
          git push origin "${{ steps.create-branch.outputs.branch_name }}"

      - name: Create Pull Request
        if: steps.create-branch.outputs.has_changes == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            // Claude ì‹¤í–‰ ê²°ê³¼ ì½ê¸°
            let claudeOutput = "ë²„ê·¸ ìˆ˜ì • ì™„ë£Œ";
            try {
              const logFile = '${{ steps.claude-fix.outputs.execution_file }}';
              if (fs.existsSync(logFile)) {
                const logData = JSON.parse(fs.readFileSync(logFile, 'utf8'));
                claudeOutput = logData.result || "ë²„ê·¸ ìˆ˜ì • ì™„ë£Œ";
              }
            } catch (error) {
              console.log('ë¡œê·¸ íŒŒì‹± ì˜¤ë¥˜:', error);
            }

            const prBody = `## ğŸ› ìë™ ë²„ê·¸ ìˆ˜ì •
            
ì´ PRì€ Claude AIê°€ ì´ìŠˆ #${{ steps.parse-issue.outputs.issue_number }}ì„ ë¶„ì„í•˜ê³  ìë™ìœ¼ë¡œ ìƒì„±í•œ ë²„ê·¸ ìˆ˜ì •ì‚¬í•­ì…ë‹ˆë‹¤.

### ğŸ“‹ ìˆ˜ì • ë‚´ì—­

${claudeOutput}

### ğŸ” ê²€í†  ìš”ì²­
- [ ] ìˆ˜ì •ì‚¬í•­ì´ ì˜¬ë°”ë¥¸ì§€ ì½”ë“œ ë¦¬ë·°
- [ ] í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‹¤í–‰ ë° í™•ì¸
- [ ] ë¶€ì‘ìš©ì´ ì—†ëŠ”ì§€ í™•ì¸
- [ ] ë¬¸ì„œ ì—…ë°ì´íŠ¸ í•„ìš” ì—¬ë¶€ í™•ì¸

### ğŸ¤– AI ìƒì„± ì•ˆë‚´
ì´ ìˆ˜ì •ì‚¬í•­ì€ AIê°€ ìƒì„±í–ˆìœ¼ë¯€ë¡œ ë°˜ë“œì‹œ ì‚¬ëŒì˜ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.

---
Closes #${{ steps.parse-issue.outputs.issue_number }}`;

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ› Fix: ${{ steps.parse-issue.outputs.issue_title }}`,
              head: '${{ steps.create-branch.outputs.branch_name }}',
              base: 'main',
              body: prBody,
              draft: true  // ê²€í† ë¥¼ ìœ„í•´ ì´ˆì•ˆìœ¼ë¡œ ìƒì„±
            });

            // PR ë²ˆí˜¸ë¥¼ ì´ìŠˆì— ì½”ë©˜íŠ¸ë¡œ ë‚¨ê¹€
            await github.rest.issues.createComment({
              issue_number: ${{ steps.parse-issue.outputs.issue_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ¤– Claude AIê°€ ì´ ë²„ê·¸ì˜ ìˆ˜ì •ì‚¬í•­ì„ ë¶„ì„í•˜ê³  PR #${pr.data.number}ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.\n\nâš ï¸ **ê²€í†  í•„ìˆ˜**: AIê°€ ìƒì„±í•œ ì½”ë“œì´ë¯€ë¡œ ë°˜ë“œì‹œ ì‚¬ëŒì˜ ê²€í†  í›„ ë¨¸ì§€í•´ì£¼ì„¸ìš”.`
            });

      - name: Comment on failure
        if: steps.claude-fix.outputs.conclusion == 'failure'
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: ${{ steps.parse-issue.outputs.issue_number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸš¨ Claude AIê°€ ì´ ë²„ê·¸ë¥¼ ìë™ìœ¼ë¡œ ìˆ˜ì •í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n**ì‚¬ëŒì˜ ìˆ˜ë™ ê°œì…ì´ í•„ìš”í•©ë‹ˆë‹¤.**\n\në¡œê·¸ë¥¼ í™•ì¸í•˜ì‹œê±°ë‚˜ \`@claude fix\` ì½”ë©˜íŠ¸ë¡œ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.`
            });

      - name: Upload fix log
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: claude-bugfix-log-${{ github.run_number }}
          path: ${{ steps.claude-fix.outputs.execution_file }}
          retention-days: 7