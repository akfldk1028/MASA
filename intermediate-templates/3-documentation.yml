name: "ğŸ“š Documentation Assistant"
on:
  push:
    branches: [main, master]
    paths:
      - 'src/**'
      - 'lib/**'
      - '*.js'
      - '*.ts'
      - '*.py'
      - '*.md'
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]
  schedule:
    - cron: '0 9 * * 1'  # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ

jobs:
  documentation:
    if: |
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude docs'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect documentation needs
        id: detect-needs
        run: |
          echo "Detecting documentation needs..."
          
          # ìµœê·¼ ë³€ê²½ëœ ì½”ë“œ íŒŒì¼ë“¤ ì°¾ê¸°
          if [ "${{ github.event_name }}" = "push" ]; then
            git diff --name-only HEAD^ HEAD | grep -E '\.(js|ts|py|java|go|rs)$' > changed_code_files.txt || true
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -E '\.(js|ts|py|java|go|rs)$' > changed_code_files.txt || true
          else
            # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ì´ë‚˜ ìˆ˜ë™ ì‹¤í–‰ì˜ ê²½ìš° ëª¨ë“  íŒŒì¼ ëŒ€ìƒ
            find . -name "*.js" -o -name "*.ts" -o -name "*.py" -o -name "*.java" -o -name "*.go" -o -name "*.rs" | head -20 > changed_code_files.txt
          fi
          
          # ë¬¸ì„œê°€ ë¶€ì¡±í•œ íŒŒì¼ë“¤ í™•ì¸
          needs_docs=""
          if [ -s changed_code_files.txt ]; then
            needs_docs="true"
            echo "ğŸ“ ë¬¸ì„œí™”ê°€ í•„ìš”í•œ íŒŒì¼ë“¤ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤:"
            cat changed_code_files.txt
          else
            needs_docs="false"
            echo "ë¬¸ì„œí™”í•  ìƒˆë¡œìš´ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          fi
          
          echo "needs_docs=$needs_docs" >> $GITHUB_OUTPUT

      - name: Run Documentation Generator
        if: steps.detect-needs.outputs.needs_docs == 'true'
        id: claude-docs
        uses: ./
        with:
          prompt: |
            ğŸ“š **ë¬¸ì„œí™” ìˆ˜í–‰**
            
            **ëª©í‘œ**: ì½”ë“œë² ì´ìŠ¤ì˜ ë¬¸ì„œí™” í’ˆì§ˆì„ ê°œì„ í•˜ê³  ëˆ„ë½ëœ ë¬¸ì„œë“¤ì„ ìƒì„±
            
            **ìˆ˜í–‰í•  ì‘ì—…:**
            1. **README.md ë¶„ì„ ë° ê°œì„ **
               - í”„ë¡œì íŠ¸ ê°œìš”ê°€ ëª…í™•í•œì§€ í™•ì¸
               - ì„¤ì¹˜/ì‹¤í–‰ ë°©ë²•ì´ ì •í™•í•œì§€ ê²€ì¦
               - ì‚¬ìš© ì˜ˆì œê°€ ìµœì‹  ì½”ë“œì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
               - API ë¬¸ì„œ ë§í¬ì™€ ê¸°ì—¬ ê°€ì´ë“œ í™•ì¸
            
            2. **API ë¬¸ì„œ ìƒì„±/ì—…ë°ì´íŠ¸**
               - ëª¨ë“  public í•¨ìˆ˜/í´ë˜ìŠ¤ì— ëŒ€í•œ ë¬¸ì„œ
               - ë§¤ê°œë³€ìˆ˜, ë°˜í™˜ê°’, ì˜ˆì™¸ ì„¤ëª…
               - ì‚¬ìš© ì˜ˆì œ í¬í•¨
            
            3. **ì¸ë¼ì¸ ì½”ë“œ ì£¼ì„ ê°œì„ **
               - ë³µì¡í•œ ë¡œì§ì— ëŒ€í•œ ì„¤ëª… ì¶”ê°€
               - TODO, FIXME, HACK ì£¼ì„ ì •ë¦¬
               - JSDoc, docstring ë“± í‘œì¤€ í˜•ì‹ ì ìš©
            
            4. **CHANGELOG.md ì—…ë°ì´íŠ¸**
               - ìµœê·¼ ë³€ê²½ì‚¬í•­ ì¶”ê°€
               - ë²„ì „ë³„ ë³€ê²½ ë‚´ì—­ ì •ë¦¬
            
            5. **ê°œë°œì ê°€ì´ë“œ ì‘ì„±**
               - í”„ë¡œì íŠ¸ êµ¬ì¡° ì„¤ëª…
               - ê°œë°œ í™˜ê²½ ì„¤ì • ë°©ë²•
               - ì½”ë”© ìŠ¤íƒ€ì¼ ê°€ì´ë“œ
               - í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë°©ë²•
            
            **ì¶œë ¥ í˜•ì‹:**
            ```
            ## ğŸ“š ë¬¸ì„œí™” ì™„ë£Œ ë³´ê³ ì„œ
            
            ### âœ… ì™„ë£Œëœ ì‘ì—…
            #### ğŸ“„ ìƒì„±/ìˆ˜ì •ëœ íŒŒì¼:
            - `README.md`: [ìˆ˜ì • ë‚´ìš©]
            - `API.md`: [ìƒì„±/ìˆ˜ì • ë‚´ìš©]
            - `CHANGELOG.md`: [ì—…ë°ì´íŠ¸ ë‚´ìš©]
            - `CONTRIBUTING.md`: [ìƒì„±/ìˆ˜ì • ë‚´ìš©]
            
            #### ğŸ’¬ ì¶”ê°€ëœ ì½”ë“œ ì£¼ì„:
            - `íŒŒì¼ëª…`: [ì£¼ì„ ì¶”ê°€ ë‚´ìš©]
            
            ### ğŸ“Š ë¬¸ì„œí™” í†µê³„
            - ì´ ë¬¸ì„œí™”ëœ í•¨ìˆ˜: Nê°œ
            - ìƒˆë¡œ ìƒì„±ëœ ë¬¸ì„œ: Nê°œ
            - ì—…ë°ì´íŠ¸ëœ ë¬¸ì„œ: Nê°œ
            - ì¶”ê°€ëœ ì½”ë“œ ì£¼ì„: Nê°œ
            
            ### ğŸ¯ ê°œì„  íš¨ê³¼
            - ì½”ë“œ ì´í•´ë„ í–¥ìƒ
            - ìƒˆ ê°œë°œì ì˜¨ë³´ë”© ê°œì„ 
            - API ì‚¬ìš©ì„± í–¥ìƒ
            
            ### ğŸ“ ì¶”ê°€ ê¶Œì¥ì‚¬í•­
            - [í–¥í›„ ë¬¸ì„œ ê´€ë¦¬ ë°©ë²•]
            - [ì •ê¸°ì ì¸ ë¬¸ì„œ ì—…ë°ì´íŠ¸ ê°€ì´ë“œ]
            ```
            
            **ì£¼ì˜ì‚¬í•­:**
            - ê¸°ì¡´ ë¬¸ì„œì˜ í†¤ê³¼ ìŠ¤íƒ€ì¼ ìœ ì§€
            - ì½”ë“œì™€ ì¼ì¹˜í•˜ëŠ” ì •í™•í•œ ë¬¸ì„œ ì‘ì„±
            - ë‹¤êµ­ì–´ ì§€ì›ì´ ìˆë‹¤ë©´ í•´ë‹¹ ì–¸ì–´ë¡œë„ ì‘ì„±
            - ë§ˆí¬ë‹¤ìš´ ë¬¸ë²• ì¤€ìˆ˜
            
          allowed_tools: "Read,Write,Edit,MultiEdit,Grep,Bash(npm run test),Bash(git log)"
          
          settings: |
            {
              "enableAllProjectMcpServers": true,
              "customInstructions": "ì „ë¬¸ì ì´ê³  ëª…í™•í•œ ê¸°ìˆ  ë¬¸ì„œ ì‘ì„±. í•œêµ­ì–´ì™€ ì˜ì–´ ë³‘í–‰. ê°œë°œì ì¹œí™”ì ì¸ ì„¤ëª…."
            }
            
          timeout_minutes: "25"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Check for documentation changes
        if: steps.detect-needs.outputs.needs_docs == 'true'
        id: check-changes
        run: |
          # ë¬¸ì„œ ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if git diff --quiet && git diff --cached --quiet; then
            echo "ë¬¸ì„œ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ ìƒì„±/ìˆ˜ì •ëœ ë¬¸ì„œ:"
            git diff --name-only
          fi

      - name: Commit documentation changes
        if: steps.check-changes.outputs.has_changes == 'true' && github.event_name != 'pull_request'
        run: |
          git config user.name "Claude AI Documentation Bot"
          git config user.email "claude-docs@anthropic.com"
          
          git add -A
          git commit -m "ğŸ“š Docs: Update documentation

          - Auto-generated documentation improvements
          - Added missing API documentation
          - Updated code comments and examples
          - Enhanced README and project guides
          
          ğŸ¤– Generated by Claude AI
          Co-authored-by: Claude AI <claude@anthropic.com>"
          
          git push origin ${{ github.ref_name }}

      - name: Create documentation PR
        if: steps.check-changes.outputs.has_changes == 'true' && github.event_name == 'pull_request'
        run: |
          # PRì˜ ê²½ìš° ë³„ë„ ë¸Œëœì¹˜ì— ë¬¸ì„œ ê°œì„ ì‚¬í•­ ì»¤ë°‹
          BRANCH_NAME="docs/auto-update-pr-${{ github.event.number }}"
          
          git config user.name "Claude AI Documentation Bot"
          git config user.email "claude-docs@anthropic.com"
          git checkout -b "$BRANCH_NAME"
          
          git add -A
          git commit -m "ğŸ“š Docs: Documentation improvements for PR #${{ github.event.number }}

          Auto-generated documentation updates based on code changes
          
          ğŸ¤– Generated by Claude AI"
          
          git push origin "$BRANCH_NAME"
          
          echo "doc_branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
        id: create-doc-pr

      - name: Comment on PR with documentation
        if: github.event_name == 'pull_request' && steps.check-changes.outputs.has_changes == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            // Claude ì‹¤í–‰ ê²°ê³¼ ì½ê¸°
            let claudeOutput = "ë¬¸ì„œí™” ì™„ë£Œ";
            try {
              const logFile = '${{ steps.claude-docs.outputs.execution_file }}';
              if (fs.existsSync(logFile)) {
                const logData = JSON.parse(fs.readFileSync(logFile, 'utf8'));
                claudeOutput = logData.result || "ë¬¸ì„œí™” ì™„ë£Œ";
              }
            } catch (error) {
              console.log('ë¡œê·¸ íŒŒì‹± ì˜¤ë¥˜:', error);
            }

            const comment = `## ğŸ“š ìë™ ë¬¸ì„œí™” ê²°ê³¼

Claude AIê°€ ì´ PRì˜ ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ ë¶„ì„í•˜ì—¬ ë¬¸ì„œë¥¼ ìë™ìœ¼ë¡œ ê°œì„ í–ˆìŠµë‹ˆë‹¤.

### ğŸ“‹ ë¬¸ì„œí™” ë‚´ì—­

${claudeOutput}

### ğŸ”— ë¬¸ì„œ ê°œì„  ë¸Œëœì¹˜
ë³„ë„ ë¸Œëœì¹˜ \`${{ steps.create-doc-pr.outputs.doc_branch }}\`ì— ë¬¸ì„œ ê°œì„ ì‚¬í•­ì´ ì»¤ë°‹ë˜ì—ˆìŠµë‹ˆë‹¤.

### ğŸ“ ë‹¤ìŒ ë‹¨ê³„
1. ì´ PRì„ ë¨¼ì € ë¦¬ë·°í•˜ê³  ë¨¸ì§€
2. ë¬¸ì„œ ê°œì„  ë¸Œëœì¹˜ë„ ë¦¬ë·° í›„ ë¨¸ì§€
3. ë˜ëŠ” ì´ PRì— ë¬¸ì„œ ë³€ê²½ì‚¬í•­ì„ í¬í•¨í•˜ì—¬ í•¨ê»˜ ë¨¸ì§€

---
*ğŸ¤– AIê°€ ìƒì„±í•œ ë¬¸ì„œì´ë¯€ë¡œ ê²€í†  í›„ ì‚¬ìš©í•´ì£¼ì„¸ìš”*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Update project documentation index
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          # docs ë””ë ‰í† ë¦¬ê°€ ìˆë‹¤ë©´ ì¸ë±ìŠ¤ íŒŒì¼ ì—…ë°ì´íŠ¸
          if [ -d "docs" ]; then
            echo "ğŸ“š ë¬¸ì„œ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸ ì¤‘..."
            find docs -name "*.md" | sort > docs/INDEX.md.tmp
            if [ -f "docs/INDEX.md.tmp" ]; then
              echo "# ğŸ“š ë¬¸ì„œ ì¸ë±ìŠ¤" > docs/INDEX.md
              echo "" >> docs/INDEX.md
              echo "ì´ í”„ë¡œì íŠ¸ì˜ ëª¨ë“  ë¬¸ì„œ ëª©ë¡ì…ë‹ˆë‹¤." >> docs/INDEX.md
              echo "" >> docs/INDEX.md
              while read -r file; do
                filename=$(basename "$file" .md)
                echo "- [$filename]($file)" >> docs/INDEX.md
              done < docs/INDEX.md.tmp
              rm docs/INDEX.md.tmp
              
              # ë³€ê²½ì‚¬í•­ì´ ìˆë‹¤ë©´ ì»¤ë°‹ì— í¬í•¨
              git add docs/INDEX.md
            fi
          fi

      - name: Generate documentation stats
        if: always()
        run: |
          echo "ğŸ“Š ë¬¸ì„œí™” í†µê³„:"
          echo "- Markdown íŒŒì¼: $(find . -name '*.md' | wc -l)ê°œ"
          echo "- README íŒŒì¼: $(find . -name 'README*' | wc -l)ê°œ"
          echo "- ì£¼ì„ì´ ìˆëŠ” ì½”ë“œ íŒŒì¼: $(grep -r '//\|#\|/\*\|"""' --include="*.js" --include="*.ts" --include="*.py" . | cut -d: -f1 | sort -u | wc -l)ê°œ"

      - name: Upload documentation log
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: claude-docs-log-${{ github.run_number }}
          path: ${{ steps.claude-docs.outputs.execution_file }}
          retention-days: 14

      - name: Comment on manual trigger
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            let claudeOutput = "ë¬¸ì„œí™” ì‘ì—… ì™„ë£Œ";
            if (fs.existsSync('${{ steps.claude-docs.outputs.execution_file }}')) {
              try {
                const logData = JSON.parse(fs.readFileSync('${{ steps.claude-docs.outputs.execution_file }}', 'utf8'));
                claudeOutput = logData.result || "ë¬¸ì„œí™” ì‘ì—… ì™„ë£Œ";
              } catch (error) {
                console.log('ë¡œê·¸ íŒŒì‹± ì˜¤ë¥˜:', error);
              }
            }

            const hasChanges = '${{ steps.check-changes.outputs.has_changes }}' === 'true';
            const status = hasChanges ? "âœ… ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì™„ë£Œ" : "â„¹ï¸ ë¬¸ì„œ ì—…ë°ì´íŠ¸ ë¶ˆí•„ìš”";

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ“š ${status}

${claudeOutput}

${hasChanges ? 'ë¬¸ì„œê°€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'í˜„ì¬ ë¬¸ì„œê°€ ìµœì‹  ìƒíƒœì…ë‹ˆë‹¤.'}`
            });

      - name: Summary
        if: always()
        run: |
          echo "ğŸ‰ ë¬¸ì„œí™” ì›Œí¬í”Œë¡œìš° ì™„ë£Œ!"
          echo "- íŠ¸ë¦¬ê±°: ${{ github.event_name }}"
          echo "- ë¬¸ì„œ ë³€ê²½: ${{ steps.check-changes.outputs.has_changes }}"
          echo "- ê²°ê³¼: ${{ steps.claude-docs.outputs.conclusion }}"